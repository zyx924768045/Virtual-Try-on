!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Monitor={})}(this,function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function n(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}c((r=r.apply(e,t||[])).next())})}function r(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function i(){return(new Date).toISOString()}function o(){return[(new Date).valueOf().toString(),function(e){void 0===e&&(e=0);for(var t=[],n=0;n<e;n++)t.push("0123456789abcdef".charAt(Math.floor(16*Math.random())));return t.join("")}(4)].join("")}function a(){var e="mh_"+Math.random(),t=new RegExp("(^|;)\\s*"+e+"=12345"),n=new Date(0),r=document.domain.split("."),i=[];for(i.unshift(r.pop());r.length;){i.unshift(r.pop());var o=i.join("."),a=e+"=12345;domain=."+o;if(document.cookie=a,t.test(document.cookie))return document.cookie=a+";expires="+n,o}}function s(e){return void 0===e&&(e=location.origin),Boolean(e.match(/baidu.com/))}var c={};function u(e){return"string"==typeof e&&""!==e}function d(e){return u(e)}c.set=function(e,t,n){if(void 0===n&&(n={}),d(e)){var r=n.expires;"number"==typeof r&&(r=new Date).setTime(r.getTime()+n.expires),document.cookie=e+"="+(n.raw?t:encodeURIComponent(t))+(r instanceof Date?"; expires="+r.toUTCString():"")+(n.domain?"; domain="+n.domain:"")+(n.path?"; path="+n.path:"")+(n.secure?"; secure":"")}},c.get=function(e,t){return void 0===t&&(t={}),function(e,t){if(u(e)){var n=String(document.cookie).match(new RegExp("(?:^|)"+e+"(?:(?:=([^;]*))|;|$)"));if(n)return t?decodeURIComponent(n[1]):n[1]}return null}(d(e)?e:"",!t.raw)},c.remove=function(e,t){void 0===t&&(t={}),t.raw=!0,t.expires=new Date(0),this.set(e,"",t)};var l="MONITOR_SESSION_ID";var f={get:function(){return localStorage.getItem(l)},set:function(e){var t=e||o();return localStorage.setItem(l,t),t}},p="MONITOR_CROSS_SUB_DOMAIN_TRACK_SESSION_ID";function h(e){var t=e||o();return c.set(p,t,{domain:"."+a(),path:"/",expires:18e5}),t}var g={get:function(){var e=c.get(p);return null!==e&&h(e),e},set:h},v="https://console.bce.baidu.com/asset/monitor/bce_monitor_session.html",m=v.match(/http.*\.com/)[0],w=null;var y={get:function(){return null===w?function(){if(!location.host.includes("baidu.com"))throw new Error('无法在非 *.baidu.com 域下使用 "bce" 模式记录 sessionId ');return(w=document.createElement("iframe")).src=v,w.style.display="none",document.body.appendChild(w),new Promise(function(e){w.onload=function(){w.contentWindow.postMessage({action:"getSession"},m),window.addEventListener("message",function t(n){"getSession"===n.data.action&&(window.removeEventListener("message",t),e(n.data.value))})}})}():new Promise(function(e){w.contentWindow.postMessage({action:"getSession"},m),window.addEventListener("message",function t(n){"getSession"===n.data.action&&(window.removeEventListener("message",t),e(n.data.value))})})},set:function(e){var t=e||o();return w.contentWindow.postMessage({action:"setSession",value:t},m),t}},b="MINITOR_LAST_PAGE_VIEW",I="MONITOR_CURRENT_PAGE_VIEW";function S(){var e=sessionStorage.getItem(I);return null===e?null:JSON.parse(e)}var k={getPageViewId:function(){var e=S();return e&&e.pageViewId||""},getCurrentPage:S,setCurrentPage:function(e){return sessionStorage.setItem(I,JSON.stringify(e)),e},get:function(){var e=localStorage.getItem(b);if(null===e)return null;var t=JSON.parse(e);return(new Date).getTime()-new Date(t.timestamp).getTime()>18e5?(localStorage.removeItem(b),null):t},set:function(e){return localStorage.setItem(b,JSON.stringify(e)),e}},E={get path(){return location.pathname},get url(){return window.location.href},get referrer(){return document.referrer},get host(){return location.host},get network(){var e=navigator.connection;return e?e.effectiveTyp:"unknow"}},T=function(e){},O=new Promise(function(e){T=e});function P(e){return n(this,void 0,void 0,function(){var n,a,s,c,u;return r(this,function(r){switch(r.label){case 0:return[4,e.session.get()];case 1:return n=r.sent(),a=e.page.get(),s=function(e,t){var n=1;t&&(n=t.pageCount?t.pageCount+1:1);return{siteSessionId:e,pageViewId:o(),pageCount:n,lastPageViewId:t&&t.pageViewId,pagePath:location.pathname,pageUrl:location.href,pageReferrer:E.referrer,pageTitle:document.title}}(n,a),null!==a&&(c=function(e,t){return{siteSessionId:e.siteSessionId,pageViewId:e.pageViewId,nextPageViewId:t.pageViewId,pagePath:e.pagePath,pageUrl:e.pageUrl,pageReferrer:e.pageReferrer,pageVisitLength:(n=e.timestamp,(new Date).getTime()-new Date(n).getTime())};var n}(a,s),_("page_leave",t({},c))),"function"==typeof T&&T(s.pageViewId),u=t({timestamp:i()},s),e.page.set(u),e.page.setCurrentPage(u),function(e){_("page_view",t({},e))}(s),[2]}})})}function _(e,n){var r,o=t(t({type:e,appTag:J.appTag,experiment:J.experiment},n),{timestamp:i()}),a=J.api+"?newTrackData="+(r=o,encodeURIComponent(JSON.stringify(r)));(new Image).src=a}var A,V=function(){function e(e,t){var n=this;this.actionHandler=function(e){n.logger(e.type,e.currentTarget)},this.info=t,this.addElementListener([document.body]),e.autoTrack&&this.initAutoWatcher()}return e.prototype.addElementListener=function(e){var t=this;Array.prototype.forEach.call(e,function(e){if(e.nodeType===Node.ELEMENT_NODE){var n=e.querySelectorAll("[data-track-name]:not(a)"),r=e.getElementsByTagName("a"),i=function(e){Array.prototype.forEach.call(e,function(e){var n=e.getAttribute("data-track-action")||"click";e.addEventListener(n,t.actionHandler)})};i(n),i(r)}})},e.prototype.logger=function(e,t){var n,r=t.getAttribute("data-track-name"),i=t.getAttribute("data-track-value"),o=t.getAttribute("data-track-category"),a=t.getAttribute("data-track-categoary"),s={action:e,category:o||a,name:r,value:i,href:(n=t,void 0!==n.href?t.href:"")};for(var c in s)s[c]||(s[c]="");return this.sendEvent(s)},e.prototype.sendEvent=function(e){return n(this,void 0,void 0,function(){var n,i,o;return r(this,function(r){switch(r.label){case 0:return[4,Promise.all([this.info.session.get(),this.info.page.getPageViewId()])];case 1:return n=r.sent(),i=n[0],o=n[1],_("behavior",t(t({},e),{pageViewId:o,siteSessionId:i})),[2]}})})},e.prototype.initAutoWatcher=function(){var e=this;if("function"==typeof window.MutationObserver){var t,n,r,i=[],o=(t=function(t){var n=t.map(function(e){return e.addedNodes}).reduce(function(e,t){return e.concat(Array.from(t))},[]);e.addElementListener(n),i=[]},n=500,r=null,function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];null!==r&&clearTimeout(r),r=setTimeout(function(){t.apply(null,e)},n)});new MutationObserver(function(e){i=i.concat(e),o(i)}).observe(document.body,{childList:!0,subtree:!0})}else console.log("不支持 MutaionObserver")},e}(),C="CAMPAIGN_TRACK",M="https://cloud.baidu.com/helper/monitor.html",N=M.match(/http.*\.com/)[0];function R(e,t){return A||!function(e,t){if(e.api!==W||!t)return!1;var n="cloud.baidu.com"===location.hostname,r=location.host.includes("baidu.com");return!n&&r}(e,t)?Promise.resolve():((A=document.createElement("iframe")).src=M,A.style.display="none",document.body.appendChild(A),new Promise(function(e,n){A.onload=function(){A.contentWindow.postMessage({action:"syncTrackCookie",payload:t},N),window.addEventListener("message",function t(n){var r=n.data;"syncTrackCookie"===r.action&&r.payload&&(window.removeEventListener("message",t),e())}),setTimeout(function(){e()},7e3)}}))}function x(e){return n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:return[4,e.session.get()];case 1:return(n=r.sent())?[3,3]:[4,e.session.set()];case 2:n=r.sent(),_("site_view",t({siteSessionId:n,siteEntrance:E.url,siteReferrer:E.referrer,siteHost:E.host,network:E.network,campaignTrack:c.get("CAMPAIGN_TRACK")},e.visitor.get())),r.label=3;case 3:return[2]}})})}var D="MONITOR_VISITOR_ID";var L={get:function(){var e=localStorage.getItem(D);return e?{visitorId:e,visitorType:"old"}:(e=J.userid,localStorage.setItem(D,e),{visitorId:e,visitorType:"new"})}};function U(e){var t=window.history[e];return function(){var n=t.apply(this,arguments),r=new Event(e);return r.arguments=arguments,window.dispatchEvent(r),n}}var j=function(){function e(e){var t,n=this;switch(e.session){case"bce":this.session=y;break;case"crossSubDomain":this.session=g;break;case"storage":this.session=f;break;default:this.session=f}switch(e.router){case"history":t=this.trackPageViewEvent.bind(this),window.history.pushState=U("pushState"),window.history.replaceState=U("replaceState"),window.addEventListener("pushState",t),window.addEventListener("replaceState",t);break;case"hash":!function(e){window.addEventListener("hashchange",e)}(this.trackPageViewEvent.bind(this));break;default:console.error("router mode '"+e.router+"' isn't support.")}this.config=e,this.visitor=L,this.page=k,this.tracker=this.initTracker();var r,i=(r=location.search.slice(1).split("&").reduce(function(e,t){var n=t.split("="),r=n[0],i=n[1];return e[r]=i,e},{}).track)?(c.set(C,r,{domain:"."+location.hostname,path:"/",expires:7776e6}),r):r;R(e,i).then(function(){e.autoTrack&&n.initAutoTrack()})}return e.prototype.initTracker=function(){return{behavior:new V(this.config,{page:this.page,session:this.session})}},e.prototype.initAutoTrack=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.trackSiteViewEvent()];case 1:return e.sent(),[4,this.trackPageViewEvent()];case 2:return e.sent(),[2]}})})},e.prototype.trackSiteViewEvent=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,x({session:this.session,visitor:this.visitor})];case 1:return e.sent(),[2]}})})},e.prototype.trackPageViewEvent=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,P({session:this.session,page:this.page})];case 1:return e.sent(),[2]}})})},e}(),W="https://cloud.baidu.com/img/bh.gif",G={api:W,router:"history",userid:"",autoTrack:!0,session:s()?"bce":"storage"},J=G;var B={init:function(e){var n=t(t({},G),e);return""===(J=n).userid&&Object.defineProperty(J,"userid",{get:o}),new j(n)},trackBehavior:function(e){return n(this,void 0,void 0,function(){return r(this,function(i){return O.then(function(){!function(e){n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:return s()?[4,y.get()]:[3,2];case 1:return n=r.sent(),[3,3];case 2:n=f.get(),r.label=3;case 3:return _("behavior",t(t({},e),{pageViewId:k.getPageViewId(),siteSessionId:n})),[2]}})})}(e)}),[2]})})}};e.default=B,Object.defineProperty(e,"__esModule",{value:!0})});
